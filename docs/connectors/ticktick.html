<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<script src="js/storage.js"></script>
</head>

<body>
	<div id="main" style="display: none;">
		<h2>Add Task</h2>
		<div id="message"></div>
		<div id="title"></div>
		<div id="url"></div>
	</div>
	<script>
		(function () {
			const page = {};
			const all = document.querySelectorAll("*[id]");
			all.forEach((val) => {
				page[val.id] = val;
			});
			let storage = new CbStorage("ticktick");
			storage.save();
			let clientId = storage.getItem("clientid");
			let secret = storage.getItem("secret");
			let key = storage.getItem("key");
			let state;
			if (!clientId) {
				clientId = prompt("Enter clientId");
				storage.setItem("clientid", clientId);
				secret = prompt("Enter secret");
				storage.setItem("secret", secret);

				let key = "";
				for (let n = 0; n < 5; n++) {
					key += (Math.random() + 1).toString(36).substring(7);
				}
				storage.setItem("key", key);
			}

			let params = Object.fromEntries((new URLSearchParams(location.search)).entries());
			console.log(params);
			alert("check console");
			console.log(storage.getStorage());
			let thisUrl = window.location.href.split("?")[0];

			if (!params.code && !params.state) {
				if (!params.task || !params.content) {
					return showPage("Bad request - needs task and content", params);
				}
				let state = new Date().getTime();
				storage.setItem("state", {state, code: params.task, content: params.content});
				params.state = state;
				firstStep(params);
			} else if (!params.access_token) {
				if (!params.code || !params.state) {
					return showPage("Bad response - needs code and state", params);
				}
				let state = storage.getItem("state");
				if (!state || state.state != params.state) {
					return showPage("State not found", params);
				}
				state = secondStep(params);
				console.log(state);
			} else {
				thirdStep(params);
			}

			async function firstStep(params) {
				console.log("Step 1", params);
				let dest = `https://ticktick.com/oauth/authorize?client_id=${clientId}&scope=tasks:write&state=${params.state}&redirect_uri=${thisUrl}&response_type=code`;

				//location = dest;
			}

			async function secondStep(params) {
				console.log("Step 2", params);

				let postParams = {
					client_id: clientId,
					client_secret: secret,
					code: params.code,
					grant_type: "authorization_code",
					scope: "tasks:write",
					redirect_uri: thisUrl
				};
				post("https://ticktick.com/oauth/token", postParams);
			}

			async function thirdStep(params) {
				console.log("Step 3", params);
				let postParams = {
					title: params.state.task,
					content: params.state.content
				};
				fetch("https://api.ticktick.com/open/v1/task", {
					body: postParams,
					method: "POST",
					headers: {
						"Authorization": "Bearer " + params.access_token
					}
				});
			}

			function showPage(message = "Ready", params) {
				page.main.style.display = "initial";
				page.message.innerHTML = message;
			}
		})();

		function post(path, params) {
			fetch(path, {
				body: params,
				method: "POST",
			}).then(response => {
				console.log(response);
			});
			// //https://stackoverflow.com/questions/133925/javascript-post-request-like-a-form-submit
			// const form = document.createElement('form');
			// form.method = "post";
			// form.action = path;

			// for (const key in params) {
			// 	if (params.hasOwnProperty(key)) {
			// 		const hiddenField = document.createElement('input');
			// 		hiddenField.type = 'hidden';
			// 		hiddenField.name = key;
			// 		hiddenField.value = params[key];

			// 		form.appendChild(hiddenField);
			// 	}
			// }

			// document.body.appendChild(form);
			// form.submit();
		}

	</script>

</body>

</html>
